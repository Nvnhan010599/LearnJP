<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool T√°ch CSV S·∫°ch (No Header, No STT)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #333; margin-top: 0; }
        textarea { width: 100%; height: 250px; padding: 15px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; box-sizing: border-box; font-size: 14px; }
        textarea:focus { outline: none; border-color: #007bff; }
        .btn-group { margin-top: 15px; display: flex; gap: 10px; }
        button { border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        .btn-process { background-color: #007bff; color: white; }
        .btn-process:hover { background-color: #0056b3; }
        .btn-clear { background-color: #e9ecef; color: #333; }
        .btn-clear:hover { background-color: #dde2e6; }
        #status { margin-top: 20px; font-weight: bold; color: #495057; }
        .file-list { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .file-item { background: #fff; border: 1px solid #dee2e6; padding: 15px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .file-item span { font-weight: 600; font-size: 0.9em; color: #333; }
        .file-item a { text-decoration: none; color: white; background-color: #28a745; padding: 6px 15px; border-radius: 4px; font-size: 0.9em; }
        .file-item a:hover { background-color: #218838; }
        .note { background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; font-size: 0.9em; margin-bottom: 15px; border-left: 4px solid #ffeeba; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõ†Ô∏è Tool T√°ch CSV S·∫°ch (Anki Ready)</h2>
    <div class="note">
        ‚ú® <b>T√≠nh nƒÉng m·ªõi:</b> T·ª± ƒë·ªông x√≥a d·∫•u <b>*</b> ·ªü c·ªôt 1, 2. X√≥a d√≤ng ti√™u ƒë·ªÅ. X√≥a c·ªôt s·ªë th·ª© t·ª± cu·ªëi c√πng.
    </div>
    
    <textarea id="inputText" placeholder="D√°n n·ªôi dung b·∫£ng t·ª´ NotebookLM v√†o ƒë√¢y...
V√≠ d·ª•:
| **„Åç„Åè** | **Âäπ„Åè** | C√≥ t√°c d·ª•ng | ... | 171
| „ÅØ„ÇÑ„Çã | ÊµÅË°å„Çã | Th·ªãnh h√†nh | ... | 172"></textarea>
    
    <div class="btn-group">
        <button class="btn-process" onclick="processData()">üöÄ X·ª≠ l√Ω & T·∫£i File</button>
        <button class="btn-clear" onclick="clearText()">üóëÔ∏è X√≥a</button>
    </div>

    <div id="status"></div>
    <div id="downloadArea" class="file-list"></div>
</div>

<script>
    function processData() {
        const text = document.getElementById('inputText').value;
        const lines = text.split('\n');
        const validRows = [];
        
        // 1. PARSE: L·ªçc ra c√°c d√≤ng l√† b·∫£ng Markdown
        lines.forEach(line => {
            const trimLine = line.trim();
            if (trimLine.includes('|') && !trimLine.includes('---')) {
                // T√°ch c·ªôt
                let cols = trimLine.split('|').map(c => c.trim());
                
                // B·ªè c·ªôt r·ªóng ƒë·∫ßu cu·ªëi do Markdown
                if (cols.length > 0 && cols[0] === '') cols.shift();
                if (cols.length > 0 && cols[cols.length - 1] === '') cols.pop();

                // B·ªè d√≤ng Header (ch·ª©a ch·ªØ "C·ªôt" ho·∫∑c "Hiragana")
                const isHeader = cols[0].toLowerCase().includes('c·ªôt') || cols[0].toLowerCase().includes('hiragana');
                
                // Ch·ªâ l·∫•y d√≤ng d·ªØ li·ªáu, b·ªè header
                if (!isHeader && cols.length >= 2) {
                    validRows.push(cols);
                }
            }
        });

        const statusDiv = document.getElementById('status');
        const downloadArea = document.getElementById('downloadArea');
        downloadArea.innerHTML = ''; // Reset

        if (validRows.length === 0) {
            statusDiv.innerHTML = '<span style="color:red">‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu b·∫£ng. Vui l√≤ng ki·ªÉm tra l·∫°i.</span>';
            return;
        }

        statusDiv.innerText = `‚úÖ ƒê√£ x·ª≠ l√Ω ${validRows.length} t·ª´ v·ª±ng. S·∫µn s√†ng t·∫£i xu·ªëng:`;

        // 2. BATCHING & CLEANING
        const batchSize = 10;
        
        // Y√äU C·∫¶U 1: Kh√¥ng c√≥ Header text, ch·ªâ c√≥ BOM ƒë·ªÉ Excel hi·ªÉu ti·∫øng Vi·ªát
        const bom = "\uFEFF"; 

        for (let i = 0; i < validRows.length; i += batchSize) {
            const batch = validRows.slice(i, i + batchSize);
            let csvContent = bom;

            // X√°c ƒë·ªãnh t√™n file d·ª±a tr√™n STT c·ªßa d√≤ng ƒë·∫ßu v√† d√≤ng cu·ªëi trong batch (tr∆∞·ªõc khi x√≥a c·ªôt STT)
            // C·ªôt STT th∆∞·ªùng l√† c·ªôt cu·ªëi c√πng
            let startSTT = i + 1;
            let endSTT = i + batch.length;
            
            try {
                // Th·ª≠ l·∫•y STT th·ª±c t·∫ø t·ª´ c·ªôt cu·ªëi c√πng c·ªßa d√≤ng ƒë·∫ßu ti√™n trong batch
                const lastColIdx = batch[0].length - 1;
                const potentialStart = parseInt(batch[0][lastColIdx].replace(/\D/g,''));
                const potentialEnd = parseInt(batch[batch.length-1][lastColIdx].replace(/\D/g,''));
                if (!isNaN(potentialStart)) startSTT = potentialStart;
                if (!isNaN(potentialEnd)) endSTT = potentialEnd;
            } catch(e) {}

            // X·ª≠ l√Ω t·ª´ng d√≤ng trong batch
            batch.forEach(row => {
                // Y√äU C·∫¶U 2: X√≥a d·∫•u * ·ªü C·ªôt 1 v√† C·ªôt 2
                if (row[0]) row[0] = row[0].replace(/\*/g, ''); // C·ªôt Hiragana
                if (row[1]) row[1] = row[1].replace(/\*/g, ''); // C·ªôt Kanji

                // Y√äU C·∫¶U 3: B·ªè c·ªôt cu·ªëi c√πng (STT)
                // T·∫°o m·∫£ng m·ªõi b·ªè ph·∫ßn t·ª≠ cu·ªëi
                const dataRow = row.slice(0, -1);

                // Escape CSV (th√™m ngo·∫∑c k√©p n·∫øu c√≥ d·∫•u ph·∫©y)
                const escapedRow = dataRow.map(cell => `"${cell.replace(/"/g, '""')}"`);
                
                csvContent += escapedRow.join(",") + "\n";
            });

            // T·∫°o n√∫t download
            const fileName = `TuVung_${startSTT}_${endSTT}.csv`;
            createDownloadButton(csvContent, fileName, downloadArea);
        }
    }

    function createDownloadButton(content, fileName, container) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `<span>${fileName}</span> <a href="${url}" download="${fileName}">‚¨áÔ∏è T·∫£i v·ªÅ</a>`;
        
        container.appendChild(div);
    }

    function clearText() {
        document.getElementById('inputText').value = '';
        document.getElementById('status').innerText = '';
        document.getElementById('downloadArea').innerHTML = '';
        document.getElementById('inputText').focus();
    }
</script>

</body>
</html>