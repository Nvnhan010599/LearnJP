<!DOCTYPE html>
<html lang="vi" class="dark"> <!-- Bắt đầu với dark mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học 132 Động Từ N5</title>
    <!-- Sử dụng Tailwind CSS cho giao diện hiện đại -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thư viện icon -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- File dữ liệu động từ -->
    <script src="data.js"></script>
    <style>
        /* --- Background & Base Colors --- */
        body {
            background: #000000;
            color: #ffffff;
        }

        /* --- Neon Colors --- */
        :root {
            --neon-blue: #00f7ff;
            --neon-green: #39ff14;
            --neon-yellow: #fff700;
            --neon-orange: #ff9900;
            --accent-color: var(--neon-blue);
            --bg-dark: #000000;
        }

        /* --- Glassmorphism --- */
        .glass-card {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(0, 247, 255, 0.1);
        }

        /* --- Navigation --- */
        .nav-item {
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            background: transparent;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            color: var(--accent-color);
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--accent-color);
            text-shadow: 0 0 8px var(--accent-color);
        }

        .nav-item.active {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            text-shadow: 0 0 8px var(--accent-color);
        }

        /* --- Buttons --- */
        .btn-primary {
            background: #000000;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            text-shadow: 0 0 5px var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: rgba(0, 247, 255, 0.1);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-primary:hover, .btn-secondary:hover {
            background: rgba(0, 247, 255, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
            text-shadow: 0 0 5px var(--accent-color);
        }

        /* --- Progress Bar --- */
        .progress-bar {
            background: var(--accent-color);
            box-shadow: 0 0 20px var(--accent-color);
        }

        /* Override existing gradient styles */
        body {
            animation: none;
            background: var(--bg-dark);
        }

        html.light body {
            background: #f0f9ff;
        }

        /* --- Phong cách Glassmorphism --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        html.light .glass-card {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        /* Điều chỉnh màu cho các thành phần */
        .nav-item {
            color: rgba(255, 255, 255, 0.7);
        }

        .nav-item:hover {
            color: var(--neon-blue);
            background: rgba(0, 247, 255, 0.1);
            text-shadow: 0 0 8px var(--neon-blue);
        }

        .nav-item.active {
            background: rgba(0, 0, 0, 0.8);
            color: var(--neon-blue);
            text-shadow: 0 0 8px var(--neon-blue);
        }

        .nav-item.active::before {
            background: var(--neon-blue);
            box-shadow: 0 0 15px var(--neon-blue);
        }

        /* Màu cho text và elements khác */
        .text-primary { color: rgb(139, 92, 246); }
        .text-secondary { color: rgb(192, 132, 252); }
        .bg-primary { background: rgba(139, 92, 246, 0.2); }
        .bg-success { background: rgba(16, 185, 129, 0.2); }
        .bg-warning { background: rgba(245, 158, 11, 0.2); }

        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        /* --- Tùy chỉnh các thành phần --- */
        .nav-collapsed {
            width: 5rem;
        }
        .nav-collapsed .nav-text {
            display: none;
        }
        .nav-collapsed .nav-group-title {
            display: none;
        }
        .nav-group {
            @apply space-y-1;
        }
        .nav-group-title {
            @apply text-xs uppercase tracking-wider text-gray-400 font-semibold px-6 py-2;
        }
        .nav-item {
            @apply px-4 py-3;
            display: flex;
            align-items: center;
            color: rgba(209, 213, 219, 1);
            transition: all 0.2s;
            position: relative;
        }

        .nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(99, 102, 241, 0.1);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: rgb(99, 102, 241);
        }

        .nav-icon {
            width: 24px; /* Icon to hơn */
            height: 24px;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .nav-text {
            font-size: 15px; /* Text to hơn */
            font-weight: 500;
            line-height: 24px; /* Line height bằng với icon */
            white-space: nowrap;
        }

        #sidebar.nav-collapsed {
            width: 72px !important; /* Điều chỉnh độ rộng khi thu gọn */
        }
        
        #sidebar.nav-collapsed .nav-text {
            display: none;
        }
        
        #sidebar.nav-collapsed .nav-icon {
            margin: 0;
            width: 26px; /* Icon to hơn chút khi thu gọn */
            height: 26px;
        }

        /* Điều chỉnh header */
        #sidebar .header {
            padding: 1.25rem 1rem;
        }
        
        #sidebar .header h1 {
            font-size: 1.25rem;
            line-height: 1;
        }

        /* --- Modal Style --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        /* Điều chỉnh navigation */
        #sidebar {
            width: 220px; /* Giảm độ rộng tổng thể */
            border-radius: 0;
            margin: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        #sidebar.nav-collapsed {
            width: 72px !important; /* Điều chỉnh độ rộng khi thu gọn */
        }
        
        #sidebar.nav-collapsed .nav-text {
            display: none;
        }
        
        #sidebar.nav-collapsed .nav-icon {
            margin: 0;
            width: 26px; /* Icon to hơn chút khi thu gọn */
            height: 26px;
        }
        
        .nav-icon {
            @apply w-5 h-5 flex-shrink-0;
            margin-right: 1rem;
            transition: all 0.3s ease;
        }
        
        /* Điều chỉnh main content */
        .main-content {
            padding: 2rem 2.5rem;
        }

        /* --- Nút chính không dùng gradient --- */
        .btn-primary {
            background: #000000;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            text-shadow: 0 0 5px var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: rgba(0, 247, 255, 0.1);
            transform: translateY(-1px);
        }

        /* Thêm style cho nút gói đã hoàn thành */
        .package-btn-completed {
            background: rgba(16, 185, 129, 0.1) !important;
            border-color: rgb(16, 185, 129) !important;
            color: rgb(16, 185, 129) !important;
        }
        .package-btn-completed:hover {
            background: rgba(16, 185, 129, 0.2) !important;
        }
        .package-btn-completed i {
            color: rgb(16, 185, 129);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Sidebar */
            #sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100% !important;
                height: 60px;
                flex-direction: row;
                z-index: 50;
            }

            #sidebar .header {
                display: none;
            }

            #sidebar .nav-container {
                flex-direction: row;
                justify-content: space-around;
                width: 100%;
            }

            .nav-item {
                padding: 0.5rem;
                justify-content: center;
                flex-direction: column;
                height: 100%;
                font-size: 0.75rem;
                flex-grow: 1; /* Make items share space equally */
            }
            
            /* FIX: Reset styles for settings item on mobile */
            .nav-item[data-view="settings"] {
                margin-top: 0 !important;
                border-top: none !important;
            }

            .nav-icon {
                margin: 0 0 0.25rem 0;
                width: 20px;
                height: 20px;
            }

            .nav-text {
                font-size: 0.7rem;
                margin-top: 2px;
            }

            /* Main Content */
            .main-content {
                padding: 1rem;
                padding-bottom: 70px; /* Space for bottom nav */
            }

            /* Cards & Buttons */
            .glass-card {
                margin: 0 -1rem;
                border-radius: 0;
            }

            .grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Text Sizes */
            h2.text-4xl {
                font-size: 1.875rem;
                margin-bottom: 1rem;
            }

            /* Quiz & Learn Views */
            .quiz-option-btn, .learn-option-btn {
                padding: 0.75rem !important;
                font-size: 0.9rem !important;
            }

            /* Package Buttons */
            [data-package-index] {
                padding: 0.75rem !important;
                font-size: 0.9rem !important;
            }

            /* Verb Table */
            .verb-table-container {
                margin: 0 -1rem;
                border-radius: 0;
            }

            .verb-table-container td {
                padding: 0.5rem;
                font-size: 0.9rem;
            }

            /* Modal */
            .modal-content {
                margin: 0.5rem;
                max-height: calc(100vh - 2rem);
                overflow-y: auto;
            }
        }

        /* Adjust layout for mobile landscape */
        @media (max-height: 500px) and (orientation: landscape) {
            #sidebar {
                display: none;
            }

            .main-content {
                padding-bottom: 1rem;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .grid {
                grid-template-columns: repeat(3, 1fr) !important;
            }

            .main-content {
                padding: 1.5rem;
            }
        }

        /* Note Editor Styles */
        .note-editor {
            min-height: 100px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-radius: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .note-editor:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.4);
            border-color: var(--neon-blue);
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.1);
        }

        .note-editor:empty:before {
            content: 'Nhập ghi chú của bạn...';
            color: rgba(255, 255, 255, 0.3);
        }

        /* Editor toolbar styles */
        .editor-toolbar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Styles for notes view */
        .note-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .note-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .note-verb {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--neon-blue);
        }

        .note-reading {
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        .note-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
        }

        .note-empty {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* Learning hub card styles */
        .learning-card {
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .learning-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 247, 255, 0.2);
        }
    </style>
</head>
<body class="font-sans">

    <div id="app" class="flex h-screen overflow-hidden">
        <!-- Thanh điều hướng bên trái -->
        <nav id="sidebar" class="glass-card flex-shrink-0 flex flex-col relative">
            <div class="header flex items-center justify-between">
                <h1 class="font-bold text-white nav-text hover:text-primary">N5 Verbs</h1>
                <button id="toggle-nav" class="p-1.5 rounded-lg hover:bg-white/10">
                    <i data-lucide="panel-left" class="w-5 h-5 text-gray-300"></i>
                </button>
            </div>
            <!-- FIX: Simplified and robust nav container for all items -->
            <div class="nav-container flex-1 flex flex-col">
                <a href="#" class="nav-item" data-view="overview">
                    <i data-lucide="book-open" class="nav-icon"></i>
                    <span class="nav-text">Tổng quan</span>
                </a>
                <a href="#" class="nav-item" data-view="learning-hub">
                    <i data-lucide="brain" class="nav-icon"></i>
                    <span class="nav-text">Học tập</span>
                </a>
                <a href="#" class="nav-item" data-view="progress">
                    <i data-lucide="trending-up" class="nav-icon"></i>
                    <span class="nav-text">Tiến độ</span>
                </a>
                <a href="#" class="nav-item" data-view="notes">
                    <i data-lucide="sticky-note" class="nav-icon"></i>
                    <span class="nav-text">Ghi chú</span>
                </a>
                <!-- Settings item pushed to bottom on desktop via mt-auto -->
                <a href="#" class="nav-item mt-auto border-t border-white/10" data-view="settings">
                    <i data-lucide="settings" class="nav-icon"></i>
                    <span class="nav-text">Cài đặt</span>
                </a>
            </div>
        </nav>

        <!-- Nội dung chính -->
        <main class="flex-1 overflow-hidden flex flex-col">
            <div class="main-content flex-1 overflow-y-auto">
                <div id="view-overview" class="view"></div>
                <div id="view-progress" class="view hidden"></div>
                <div id="view-learning-hub" class="view hidden"></div>
                <div id="view-learn" class="view hidden"></div>
                <div id="view-te-form" class="view hidden"></div>
                <div id="view-nai-form" class="view hidden"></div>
                <div id="view-notes" class="view hidden"></div>
                <div id="view-settings" class="view hidden"></div>
            </div>
        </main>
        
        <!-- Modal Container -->
        <div id="modal-container"></div>
    </div>

    <script>
        // --- KHỞI TẠO VÀ QUẢN LÝ TRẠNG THÁI ---
        const App = {
            state: {
                currentView: 'overview',
                searchTerm: '', // Thêm dòng này
                verbs: [],
                settings: {
                    theme: 'dark', // Bắt đầu với dark mode
                    navCollapsed: false,
                },
                quiz: {
                    type: null, // 'te' or 'nai'
                    questions: [],
                    currentQuestionIndex: 0,
                    correctAnswers: 0,
                    showAnswer: false,
                },
                learn: {
                    currentPackage: 0,
                    wordsInPackage: [],
                    currentWordIndex: 0,
                    currentQuizType: 'hiragana', // 'hiragana' or 'kanji'
                    showAnswer: false,
                    reviewMode: false, // Thêm trạng thái ôn tập
                    originalPackage: [], // Lưu gói học gốc để quay lại sau
                    completedPackages: [], // Thêm mảng lưu trữ các gói đã hoàn thành
                }
            },

            init() {
                this.loadData();
                this.loadSettings();
                this.setupEventListeners();
                this.setupMobileListeners(); // Add mobile listeners
                this.render();
                lucide.createIcons();
            },

            setupMobileListeners() {
                // Handle mobile orientation change
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        this.render();
                    }, 100);
                });

                // Handle mobile back button
                window.addEventListener('popstate', (e) => {
                    if (this.state.currentView !== 'overview') {
                        e.preventDefault();
                        this.state.currentView = 'overview';
                        this.render();
                    }
                });
            },

            // --- QUẢN LÝ DỮ LIỆU (LOCALSTORAGE) ---
            loadData() {
                const savedData = localStorage.getItem('n5VerbData');
                const savedProgress = localStorage.getItem('n5LearnProgress');
                if (savedData) {
                    this.state.verbs = JSON.parse(savedData);
                } else {
                    this.state.verbs = JSON.parse(JSON.stringify(n5Verbs));
                }
                if (savedProgress) {
                    this.state.learn.completedPackages = JSON.parse(savedProgress);
                }
            },
            saveData() {
                localStorage.setItem('n5VerbData', JSON.stringify(this.state.verbs));
                localStorage.setItem('n5LearnProgress', JSON.stringify(this.state.learn.completedPackages));
            },
            loadSettings() {
                const savedSettings = localStorage.getItem('n5AppSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    this.state.settings = settings;
                    
                    // Apply nav state
                    const sidebar = document.getElementById('sidebar');
                    if (settings.navCollapsed) {
                        sidebar.classList.add('nav-collapsed');
                    }
                }
                this.applyTheme();
            },
            saveSettings() {
                const settings = {
                    ...this.state.settings,
                    navCollapsed: this.state.navCollapsed
                };
                localStorage.setItem('n5AppSettings', JSON.stringify(settings));
                this.applyTheme();
            },
            
            // --- GẮN SỰ KIỆN ---
            setupEventListeners() {
                // Listeners for static elements (sidebar)
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.state.currentView = e.currentTarget.dataset.view;
                        this.render();
                    });
                });
                
                document.getElementById('toggle-nav').addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    this.state.settings.navCollapsed = !this.state.settings.navCollapsed;
                    sidebar.classList.toggle('nav-collapsed', this.state.settings.navCollapsed);
                    this.saveSettings();
                });

                // Delegated event listener for dynamic content inside <main>
                const mainContent = document.querySelector('.main-content');
                mainContent.addEventListener('click', (e) => {
                    const target = e.target;

                    // Back to Hub from Quiz (te/nai) or from Learn Packages view
                    if (target.closest('#back-to-hub')) {
                        e.preventDefault();
                        this.state.quiz.questions = [];
                        this.state.quiz.type = null;
                        this.state.currentView = 'learning-hub';
                        this.render();
                        return;
                    }

                    // Back to Packages from Learn Quiz
                    if (target.closest('#back-to-packages')) {
                        e.preventDefault();
                        this.state.learn.wordsInPackage = [];
                        this.state.currentView = 'learn';
                        this.render();
                        return;
                    }

                    // Handle learning hub cards
                    const learningCard = target.closest('.learning-card');
                    if (learningCard) {
                        e.preventDefault();
                        this.state.currentView = learningCard.dataset.subview;
                        this.render();
                        return;
                    }

                    // Handle package selection
                    const packageBtn = target.closest('[data-package-index]');
                    if (packageBtn) {
                        e.preventDefault();
                        const index = parseInt(packageBtn.dataset.packageIndex);
                        const isCompleted = this.state.learn.completedPackages.includes(index);
                        const packages = [];
                        for (let i = 0; i < this.state.verbs.length; i += 5) {
                            packages.push(this.state.verbs.slice(i, i + 5));
                        }
                        this.startLearnPackage(index, packages, isCompleted);
                        return;
                    }

                    // Handle quiz/learn option buttons
                    const optionBtn = target.closest('.quiz-option-btn, .learn-option-btn');
                    if (optionBtn) {
                        e.preventDefault();
                        if (optionBtn.classList.contains('quiz-option-btn') && !this.state.quiz.showAnswer) {
                            this.checkQuizAnswer(optionBtn.textContent);
                        } else if (optionBtn.classList.contains('learn-option-btn') && !this.state.learn.showAnswer) {
                            this.checkLearnAnswer(optionBtn.textContent);
                        }
                        return;
                    }

                    // Handle next buttons
                    if (target.closest('#next-quiz-btn')) {
                        e.preventDefault();
                        this.nextQuizQuestion();
                        return;
                    }
                    if (target.closest('#next-learn-btn')) {
                        e.preventDefault();
                        this.nextLearnQuestion();
                        return;
                    }

                    // Handle restart quiz
                    if (target.closest('#restart-quiz-btn')) {
                        e.preventDefault();
                        this.startQuiz(this.state.quiz.type);
                        return;
                    }
                    
                    // Handle delete note button
                    const deleteNoteBtn = target.closest('.delete-note-btn');
                    if (deleteNoteBtn) {
                        e.preventDefault();
                        e.stopPropagation(); // Prevent note-item click
                        const verbId = parseInt(deleteNoteBtn.dataset.verbId);
                        this.showConfirmationModal('Bạn có chắc chắn muốn xóa ghi chú này không?', () => {
                            const verb = this.state.verbs.find(v => v.id === verbId);
                            if (verb) {
                                verb.note = '';
                                this.saveData();
                                this.render();
                                this.showCustomAlert('Đã xóa ghi chú.', 'success');
                            }
                        });
                        return;
                    }
                    
                    // Handle note item click to open modal (must be last)
                    const noteItem = target.closest('.note-item');
                    if (noteItem) {
                        e.preventDefault();
                        const verbId = parseInt(noteItem.dataset.verbId);
                        this.showVerbModal(verbId);
                        return;
                    }
                });
            },
            
            // --- CÁC HÀM RENDER ---
            render() {
                document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.view === this.state.currentView);
                });

                const currentViewEl = document.getElementById(`view-${this.state.currentView}`);
                if (currentViewEl) {
                    currentViewEl.classList.remove('hidden');
                }
                
                switch(this.state.currentView) {
                    case 'overview': this.renderOverview(); break;
                    case 'progress': this.renderProgress(); break;
                    case 'learning-hub': this.renderLearningHub(); break;
                    case 'learn': this.renderLearn(); break;
                    case 'te-form': this.renderQuiz('te'); break;
                    case 'nai-form': this.renderQuiz('nai'); break;
                    case 'notes': this.renderNotes(); break;
                    case 'settings': this.renderSettings(); break;
                }
                lucide.createIcons();
            },

            // --- RENDER CÁC VIEW CỤ THỂ ---

            // 1. TỔNG QUAN
            renderOverview() {
                const container = document.getElementById('view-overview');
                const searchBox = container.querySelector('#search-verbs');
                const cursorPosition = searchBox ? searchBox.selectionStart : 0;
                
                const filteredVerbs = this.state.verbs.filter(verb => {
                    const searchTerm = this.state.searchTerm.toLowerCase();
                    return searchTerm === '' || 
                           verb.kanji.toLowerCase().includes(searchTerm) ||
                           verb.hiragana.toLowerCase().includes(searchTerm) ||
                           verb.meaning.toLowerCase().includes(searchTerm);
                });

                // Chỉ render lại bảng kết quả nếu đã có container
                if (container.querySelector('.verb-table-container')) {
                    const tableContainer = container.querySelector('.verb-table-container');
                    tableContainer.innerHTML = `
                        <table class="w-full text-left">
                            <thead class="sticky top-0 bg-indigo-100 dark:bg-slate-800 border-b border-slate-300 dark:border-white/10">
                                <tr>
                                    <th class="p-4 w-16">STT</th>
                                    <th class="p-4">Kanji</th>
                                    <th class="p-4">Hiragana</th>
                                    <th class="p-4">Nghĩa</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredVerbs.map(verb => `
                                    <tr class="border-t border-white/10 hover:bg-white/10 cursor-pointer" 
                                        data-verb-id="${verb.id}" 
                                        onclick="App.showVerbModal(${verb.id})">
                                        <td class="p-4 font-semibold">${verb.id}</td>
                                        <td class="p-4 text-lg font-bold">${verb.kanji}</td>
                                        <td class="p-4">${verb.hiragana}</td>
                                        <td class="p-4 text-indigo-300">${verb.meaning}</td>
                                    </tr>
                                `).join('')}
                                ${filteredVerbs.length === 0 ? `
                                    <tr>
                                        <td colspan="4" class="text-center p-8 text-gray-400">
                                            ${this.state.searchTerm ? 'Không tìm thấy kết quả phù hợp.' : 'Không có dữ liệu.'}
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    `;
                } else {
                    // Render toàn bộ view lần đầu tiên
                    container.innerHTML = `
                        <div class="mb-6 space-y-4">
                            <h2 class="text-4xl font-bold text-white">Tổng quan 132 động từ</h2>
                            <div class="glass-card p-3 flex items-center space-x-3 max-w-md">
                                <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                                <input 
                                    type="text" 
                                    id="search-verbs" 
                                    placeholder="Tìm kiếm theo kanji, hiragana hoặc nghĩa..." 
                                    class="w-full bg-transparent border-none outline-none text-white placeholder-gray-400"
                                    value="${this.state.searchTerm}">
                                ${this.state.searchTerm ? `
                                    <button id="clear-search" class="text-gray-400 hover:text-white">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="glass-card h-[calc(100vh-12rem)] overflow-auto verb-table-container">
                            <table class="w-full text-left">
                                <thead class="sticky top-0 bg-indigo-100 dark:bg-slate-800 border-b border-slate-300 dark:border-white/10">
                                    <tr>
                                        <th class="p-4 w-16">STT</th>
                                        <th class="p-4">Kanji</th>
                                        <th class="p-4">Hiragana</th>
                                        <th class="p-4">Nghĩa</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredVerbs.map(verb => `
                                        <tr class="border-t border-white/10 hover:bg-white/10 cursor-pointer" 
                                            data-verb-id="${verb.id}" 
                                            onclick="App.showVerbModal(${verb.id})">
                                            <td class="p-4 font-semibold">${verb.id}</td>
                                            <td class="p-4 text-lg font-bold">${verb.kanji}</td>
                                            <td class="p-4">${verb.hiragana}</td>
                                            <td class="p-4 text-indigo-300">${verb.meaning}</td>
                                        </tr>
                                    `).join('')}
                                    ${filteredVerbs.length === 0 ? `
                                        <tr>
                                            <td colspan="4" class="text-center p-8 text-gray-400">
                                                ${this.state.searchTerm ? 'Không tìm thấy kết quả phù hợp.' : 'Không có dữ liệu.'}
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    `;

                    // Gắn event listeners lần đầu
                    const searchInput = container.querySelector('#search-verbs');
                    searchInput.addEventListener('input', (e) => {
                        this.state.searchTerm = e.target.value;
                        this.renderOverview();
                    });

                    const clearButton = container.querySelector('#clear-search');
                    if (clearButton) {
                        clearButton.addEventListener('click', () => {
                            this.state.searchTerm = '';
                            this.renderOverview();
                        });
                    }
                }

                // Khôi phục focus và vị trí con trỏ
                const newSearchBox = container.querySelector('#search-verbs');
                if (newSearchBox) {
                    newSearchBox.focus();
                    newSearchBox.setSelectionRange(cursorPosition, cursorPosition);
                }

                lucide.createIcons();
            },
            
            showVerbModal(verbId) {
                const verb = this.state.verbs.find(v => v.id === verbId);
                if (!verb) return;

                const modalContainer = document.getElementById('modal-container');
                modalContainer.innerHTML = `
                    <div id="modal-overlay" class="modal-overlay visible" onclick="App.closeVerbModal()">
                        <div class="modal-content glass-card w-full max-w-2xl m-4" onclick="event.stopPropagation()">
                            <div class="p-6 space-y-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-3xl font-bold text-white">${verb.kanji} <span class="text-xl font-normal text-gray-300">${verb.hiragana}</span></p>
                                        <p class="text-2xl text-indigo-300 font-semibold">${verb.meaning}</p>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <span class="text-sm font-bold bg-white/20 text-white px-3 py-1 rounded-full">Nhóm ${verb.group}</span>
                                        <button onclick="App.closeVerbModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-gray-300 pt-2">
                                    <p><strong class="font-semibold text-gray-200 block">Từ điển:</strong> ${verb.dictionaryForm}</p>
                                    <p><strong class="font-semibold text-gray-200 block">Thể て:</strong> ${verb.teForm}</p>
                                    <p><strong class="font-semibold text-gray-200 block">Thể ない:</strong> ${verb.naiForm}</p>
                                </div>
                                <p class="text-md italic text-gray-400"><strong>Ví dụ:</strong> ${verb.example}</p>
                                
                                <!-- Mini Editor cho Ghi chú -->
                                <div class="pt-3">
                                    <label class="font-semibold text-sm mb-2 block text-gray-200">Ghi chú:</label>
                                    <div class="editor-toolbar flex items-center space-x-2 mb-2">
                                        <button class="editor-btn p-1.5 rounded hover:bg-white/20" data-command="bold" data-verb-id="${verb.id}">
                                            <i data-lucide="bold" class="w-4 h-4"></i>
                                        </button>
                                        <button class="editor-btn p-1.5 rounded hover:bg-white/20" data-command="italic" data-verb-id="${verb.id}">
                                            <i data-lucide="italic" class="w-4 h-4"></i>
                                        </button>
                                        <button class="editor-btn p-1.5 rounded hover:bg-white/20" data-command="underline" data-verb-id="${verb.id}">
                                            <i data-lucide="underline" class="w-4 h-4"></i>
                                        </button>
                                        <div class="h-5 w-px bg-white/20"></div>
                                        <button class="color-btn w-5 h-5 rounded-full ring-2 ring-transparent hover:ring-white" style="background-color:#FBBF24" data-color="#FBBF24" data-verb-id="${verb.id}"></button>
                                        <button class="color-btn w-5 h-5 rounded-full ring-2 ring-transparent hover:ring-white" style="background-color:#4ADE80" data-color="#4ADE80" data-verb-id="${verb.id}"></button>
                                        <button class="color-btn w-5 h-5 rounded-full ring-2 ring-transparent hover:ring-white" style="background-color:#F87171" data-color="#F87171" data-verb-id="${verb.id}"></button>
                                        <button class="color-btn w-5 h-5 rounded-full ring-2 ring-transparent hover:ring-white" style="background-color:#A78BFA" data-color="#A78BFA" data-verb-id="${verb.id}"></button>
                                        <input type="color" class="custom-color-picker w-6 h-6 p-0 border-none rounded-full cursor-pointer bg-transparent" data-verb-id="${verb.id}" value="#60A5FA">
                                    </div>
                                    <div id="note-editor-modal-${verb.id}" 
                                         contenteditable="true" 
                                         class="note-editor text-white" 
                                         data-verb-id="${verb.id}">${verb.note || ''}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                this.setupModalListeners(verb.id);

                const modalContent = modalContainer.querySelector('.modal-content');
                if (window.innerWidth < 768) {
                    modalContent.style.maxHeight = '90vh';
                    modalContent.style.width = '100%';
                    modalContent.style.margin = '1rem';
                }
            },
            
            closeVerbModal() {
                const modalOverlay = document.getElementById('modal-overlay');
                if (modalOverlay) {
                    modalOverlay.classList.remove('visible');
                    setTimeout(() => {
                        modalOverlay.parentElement.innerHTML = '';
                    }, 300); // Wait for transition to finish
                }
            },
            
            setupModalListeners(verbId) {
                const editor = document.getElementById(`note-editor-modal-${verbId}`);
                editor.addEventListener('blur', (e) => {
                    const verb = this.state.verbs.find(v => v.id === verbId);
                    if (verb) {
                        verb.note = e.target.innerHTML;
                        this.saveData();
                    }
                });

                const modal = document.querySelector('.modal-content');
                modal.querySelectorAll('.editor-btn, .color-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const command = e.currentTarget.dataset.command || 'foreColor';
                        const value = e.currentTarget.dataset.color || null;
                        document.execCommand(command, false, value);
                        editor.focus();
                    });
                });

                modal.querySelector('.custom-color-picker').addEventListener('input', (e) => {
                    document.execCommand('foreColor', false, e.target.value);
                    editor.focus();
                });
            },

            // 2. TIẾN ĐỘ
            renderProgress() {
                const container = document.getElementById('view-progress');
                const learnedCount = this.state.verbs.filter(v => (v.progress.hiragana >= 3 && v.progress.kanji >= 4)).length;
                const totalCount = this.state.verbs.length;
                const percentage = totalCount > 0 ? ((learnedCount / totalCount) * 100) : 0;

                container.innerHTML = `
                    <h2 class="text-4xl font-bold mb-8 text-white">Tiến độ học tập</h2>
                    <div class="glass-card p-8 max-w-2xl mx-auto text-center">
                        <p class="text-xl mb-4 text-gray-300">Bạn đã học được</p>
                        <p class="text-7xl font-bold text-white">${learnedCount} <span class="text-5xl text-gray-400">/ ${totalCount}</span></p>
                        <p class="text-xl mt-4 text-gray-300">động từ</p>
                        <div class="w-full bg-black/20 rounded-full h-8 mt-8 overflow-hidden">
                            <div class="bg-gradient-to-r from-green-400 to-blue-500 h-8 rounded-full flex items-center justify-center text-white font-bold transition-all duration-500" style="width: ${percentage.toFixed(1)}%">
                                ${percentage.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
            },

            // 3. HỌC TẬP - TRUNG TÂM HỌC TẬP MỚI
            renderLearningHub() {
                const container = document.getElementById('view-learning-hub');
                container.innerHTML = `
                    <h2 class="text-4xl font-bold mb-8 text-white">Trung tâm học tập</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="learning-card glass-card p-6 text-center cursor-pointer" data-subview="learn">
                            <div class="w-16 h-16 mx-auto mb-4 bg-indigo-500/20 rounded-full flex items-center justify-center">
                                <i data-lucide="book-open" class="w-8 h-8 text-indigo-300"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2 text-white">Học từ vựng</h3>
                            <p class="text-gray-300">Học 132 động từ N5 với hệ thống ghi nhớ lặp lại</p>
                        </div>
                        
                        <div class="learning-card glass-card p-6 text-center cursor-pointer" data-subview="te-form">
                            <div class="w-16 h-16 mx-auto mb-4 bg-green-500/20 rounded-full flex items-center justify-center">
                                <i data-lucide="check-circle" class="w-8 h-8 text-green-300"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2 text-white">Luyện thể て</h3>
                            <p class="text-gray-300">Luyện tập cách chia động từ sang thể て</p>
                        </div>
                        
                        <div class="learning-card glass-card p-6 text-center cursor-pointer" data-subview="nai-form">
                            <div class="w-16 h-16 mx-auto mb-4 bg-red-500/20 rounded-full flex items-center justify-center">
                                <i data-lucide="x-circle" class="w-8 h-8 text-red-300"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2 text-white">Luyện thể ない</h3>
                            <p class="text-gray-300">Luyện tập cách chia động từ sang thể ない</p>
                        </div>
                    </div>
                `;
                // NOTE: Event listeners for cards are now handled by the delegated listener
                lucide.createIcons();
            },

            // 4. HỌC TỪ VỰNG
            renderLearn() {
                const container = document.getElementById('view-learn');
                const wordsToLearn = this.state.verbs.filter(v => !(v.progress.hiragana >= 3 && v.progress.kanji >= 4));
                
                if (wordsToLearn.length === 0) {
                    container.innerHTML = `
                        <div class="flex items-center mb-4">
                            <button id="back-to-hub" class="btn-secondary mr-4 !px-3 !py-1.5">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            </button>
                            <h2 class="text-4xl font-bold text-white">Học từ vựng</h2>
                        </div>
                        <div class="glass-card p-8 text-center">
                            <i data-lucide="party-popper" class="mx-auto h-16 w-16 text-yellow-300 mb-4"></i>
                            <h3 class="text-2xl font-bold text-white">Chúc mừng!</h3>
                            <p class="mt-2 text-lg text-gray-300">Bạn đã học hết 132 động từ. Hãy tiếp tục ôn tập ở phần trắc nghiệm nhé!</p>
                        </div>`;
                    
                    // NOTE: Back button listener is now delegated
                    return;
                }

                const packages = [];
                for (let i = 0; i < this.state.verbs.length; i += 5) {
                    packages.push(this.state.verbs.slice(i, i + 5));
                }
                
                if (!this.state.learn.wordsInPackage || this.state.learn.wordsInPackage.length === 0) {
                    let html = `
                        <div class="flex items-center mb-6">
                            <button id="back-to-hub" class="btn-secondary mr-4 !px-3 !py-1.5">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            </button>
                            <h2 class="text-4xl font-bold text-white">Chọn gói học</h2>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">`;
                    packages.forEach((pkg, index) => {
                        const isCompleted = this.state.learn.completedPackages.includes(index);
                        const start = pkg[0].id;
                        const end = pkg[pkg.length - 1].id;
                        const buttonClass = isCompleted ? 'package-btn-completed' : 'btn-secondary';
                        html += `
                            <button class="btn-secondary p-6 text-lg relative flex flex-col items-center ${buttonClass}" data-package-index="${index}">
                                ${isCompleted ? '<i data-lucide="check-circle" class="w-5 h-5 mb-2"></i>' : ''}
                                <span>Gói ${start}-${end}</span>
                            </button>`;
                    });
                     html += `</div>`;
                     container.innerHTML = html;

                     // NOTE: Package selection listeners are now delegated
                     lucide.createIcons();
                } else {
                    this.renderLearnQuiz();
                }
            },
            
            startLearnPackage(index, packages, isCompleted) {
                this.state.learn.currentPackage = index;
                this.state.learn.originalPackage = [...packages[index]];
                this.state.learn.wordsInPackage = this.shuffleArray([...packages[index]]);
                this.state.learn.currentWordIndex = 0;
                this.state.learn.currentQuizType = 'hiragana';
                this.state.learn.reviewMode = isCompleted;
                this.render();
            },
            
            renderLearnQuiz() {
                const container = document.getElementById('view-learn');
                const learnState = this.state.learn;
                const currentWord = learnState.wordsInPackage[learnState.currentWordIndex];
                
                if (!currentWord) {
                    learnState.wordsInPackage = [];
                    this.renderLearn();
                    return;
                }

                const question = learnState.currentQuizType === 'hiragana' ? currentWord.hiragana : currentWord.kanji;
                const progress = learnState.currentQuizType === 'hiragana' ? currentWord.progress.hiragana : currentWord.progress.kanji;
                const target = learnState.currentQuizType === 'hiragana' ? 3 : 4;

                const wrongOptions = this.state.verbs.filter(v => v.id !== currentWord.id).sort(() => 0.5 - Math.random()).slice(0, 3).map(v => v.meaning);
                const options = [currentWord.meaning, ...wrongOptions].sort(() => 0.5 - Math.random());

                let html = `
                    <div class="max-w-2xl mx-auto">
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-to-packages" class="btn-secondary text-sm !px-3 !py-1.5">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            </button>
                             <h2 class="text-3xl font-bold text-white">Học từ vựng</h2>
                             <div></div> <!-- Empty div for flex alignment -->
                        </div>
                        <div class="glass-card p-8">
                            <p class="text-center text-gray-400 mb-2">
                                ${learnState.currentQuizType === 'hiragana' ? 'Hiragana' : 'Kanji'} (${progress}/${target})
                            </p>
                            <p class="text-7xl font-bold text-center mb-8 text-white">${question}</p>
                            <div class="grid grid-cols-2 gap-4">
                                ${options.map(opt => `<button class="learn-option-btn btn-secondary p-4 text-lg w-full">${opt}</button>`).join('')}
                            </div>
                            ${learnState.showAnswer ? `
                                <div id="learn-feedback" class="mt-6 p-4 rounded-xl text-center ${learnState.lastAnswerCorrect ? 'bg-green-500/30 text-green-200' : 'bg-red-500/30 text-red-200'}">
                                    <p class="font-bold text-lg">${learnState.lastAnswerCorrect ? 'Chính xác!' : 'Sai rồi!'}</p>
                                    <p class="text-white">${currentWord.kanji} (${currentWord.hiragana}) : ${currentWord.meaning}</p>
                                    <button id="next-learn-btn" class="btn-primary mt-4 hover:bg-opacity-80">Tiếp theo</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                container.innerHTML = html;
                // NOTE: All button listeners are now delegated
            },
            
            checkLearnAnswer(selectedAnswer) {
                const learnState = this.state.learn;
                const currentWord = learnState.wordsInPackage[learnState.currentWordIndex];
                
                learnState.showAnswer = true;
                learnState.lastAnswerCorrect = selectedAnswer === currentWord.meaning;

                if (learnState.lastAnswerCorrect) {
                     if (learnState.currentQuizType === 'hiragana') currentWord.progress.hiragana++;
                     else currentWord.progress.kanji++;
                    this.saveData();
                }
                this.render();
            },

            nextLearnQuestion() {
                const learnState = this.state.learn;
                const currentWord = learnState.wordsInPackage[learnState.currentWordIndex];
                learnState.showAnswer = false;

                if (learnState.reviewMode) {
                    // Logic ôn tập: trộn cả hiragana và kanji
                    learnState.currentQuizType = Math.random() < 0.5 ? 'hiragana' : 'kanji';
                    learnState.currentWordIndex = (learnState.currentWordIndex + 1) % learnState.wordsInPackage.length;
                    if (learnState.currentWordIndex === 0) {
                        learnState.wordsInPackage = this.shuffleArray([...learnState.wordsInPackage]);
                    }
                    this.renderLearnQuiz();
                    return;
                }

                // Kiểm tra nếu từ hiện tại đã hoàn thành
                const isCurrentWordComplete = currentWord.progress.hiragana >= 3 && currentWord.progress.kanji >= 4;

                if (learnState.reviewMode) {
                    // Chế độ ôn tập: trộn cả hiragana và kanji
                    learnState.currentQuizType = Math.random() < 0.5 ? 'hiragana' : 'kanji';
                    learnState.currentWordIndex = (learnState.currentWordIndex + 1) % learnState.wordsInPackage.length;
                    if (learnState.currentWordIndex === 0) {
                        // Xáo trộn lại khi đã học hết một lượt
                        learnState.wordsInPackage = this.shuffleArray([...learnState.wordsInPackage]);
                    }
                } else {
                    // Chế độ học bình thường
                    if (currentWord.progress.hiragana >= 3 && learnState.currentQuizType === 'hiragana') {
                        // Chuyển sang từ tiếp theo nếu đã hoàn thành hiragana
                        learnState.currentWordIndex++;
                        if (learnState.currentWordIndex >= learnState.wordsInPackage.length) {
                            // Nếu đã học hết hiragana của tất cả từ, chuyển sang kanji
                            learnState.currentWordIndex = 0;
                            learnState.currentQuizType = 'kanji';
                            learnState.wordsInPackage = this.shuffleArray([...learnState.wordsInPackage]);
                        }
                    } else if (currentWord.progress.kanji >= 4 && learnState.currentQuizType === 'kanji') {
                        // Chuyển sang từ tiếp theo nếu đã hoàn thành kanji
                        learnState.currentWordIndex++;
                        if (learnState.currentWordIndex >= learnState.wordsInPackage.length) {
                            // Kiểm tra xem có từ nào đã hoàn thành cả hiragana và kanji không
                            const completedWords = learnState.wordsInPackage.filter(
                                w => w.progress.hiragana >= 3 && w.progress.kanji >= 4
                            );
                            if (completedWords.length > 0) {
                                // Chuyển sang chế độ ôn tập cho các từ đã hoàn thành
                                learnState.reviewMode = true;
                                learnState.wordsInPackage = completedWords;
                                learnState.currentWordIndex = 0;
                                learnState.currentQuizType = Math.random() < 0.5 ? 'hiragana' : 'kanji';
                            } else {
                                // Quay lại học hiragana cho các từ chưa hoàn thành
                                learnState.currentWordIndex = 0;
                                learnState.currentQuizType = 'hiragana';
                                learnState.wordsInPackage = this.shuffleArray([...learnState.originalPackage]);
                            }
                        }
                    } else {
                        // Chuyển sang từ tiếp theo trong cùng loại (hiragana/kanji)
                        learnState.currentWordIndex = (learnState.currentWordIndex + 1) % learnState.wordsInPackage.length;
                        if (learnState.currentWordIndex === 0) {
                            // Xáo trộn lại khi đã học hết một lượt
                            learnState.wordsInPackage = this.shuffleArray([...learnState.wordsInPackage]);
                        }
                    }
                }

                // Kiểm tra hoàn thành gói
                const allWordsCompleted = learnState.originalPackage.every(
                    w => w.progress.hiragana >= 3 && w.progress.kanji >= 4
                );

                if (allWordsCompleted && !this.state.learn.completedPackages.includes(learnState.currentPackage)) {
                    this.state.learn.completedPackages.push(learnState.currentPackage);
                    this.saveData();
                    this.showCustomAlert('Chúc mừng! Bạn đã hoàn thành gói học này.', 'success');
                    setTimeout(() => {
                        learnState.wordsInPackage = [];
                        this.render();
                    }, 1500);
                    return;
                }

                this.render();
            },

            // 5 & 6. TRẮC NGHIỆM THỂ TÊ & NAI
            renderQuiz(type) {
                const container = document.getElementById(`view-${type}-form`);
                
                if (this.state.quiz.type !== type || this.state.quiz.questions.length === 0) {
                    this.startQuiz(type);
                }

                const quizState = this.state.quiz;
                const question = quizState.questions[quizState.currentQuestionIndex];

                if (!question) {
                    container.innerHTML = `
                        <div class="flex items-center mb-4">
                            <button id="back-to-hub" class="btn-secondary mr-4 !px-3 !py-1.5">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            </button>
                            <h2 class="text-2xl font-bold text-white">Hoàn thành!</h2>
                        </div>
                        <div class="glass-card p-8 text-center max-w-lg mx-auto">
                            <p class="text-lg mb-6 text-gray-300">Kết quả của bạn: <span class="font-bold text-green-300">${quizState.correctAnswers} / ${quizState.questions.length}</span></p>
                            <button id="restart-quiz-btn" class="btn-primary">Làm lại</button>
                        </div>
                    `;
                    
                    // NOTE: Back and restart button listeners are now delegated
                    return;
                }

                const progressPercentage = (quizState.currentQuestionIndex / quizState.questions.length) * 100;

                let html = `
                    <div class="flex items-center mb-6">
                        <button id="back-to-hub" class="btn-secondary mr-4 !px-3 !py-1.5">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        </button>
                        <h2 class="text-4xl font-bold text-white">Trắc nghiệm Thể ${type.toUpperCase()}</h2>
                    </div>
                    <div class="glass-card max-w-2xl mx-auto overflow-hidden">
                        <div class="w-full bg-black/20 h-2.5">
                           <div class="bg-indigo-500 h-2.5" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="p-8">
                            <p class="text-sm text-gray-400 text-right">Câu ${quizState.currentQuestionIndex + 1} / ${quizState.questions.length}</p>
                            <p class="text-center text-lg my-4 text-gray-300">Chọn thể <strong>${type.toUpperCase()}</strong> của động từ:</p>
                            <p class="text-7xl font-bold text-center mb-8 text-white">${question.verb.dictionaryForm}</p>
                            <div class="grid grid-cols-2 gap-4">
                                ${question.options.map(opt => `<button class="quiz-option-btn btn-secondary p-4 text-lg w-full">${opt}</button>`).join('')}
                            </div>
                            ${quizState.showAnswer ? `
                                <div id="quiz-feedback" class="mt-6 p-4 rounded-xl text-center ${quizState.lastAnswerCorrect ? 'bg-green-500/30 text-green-200' : 'bg-red-500/30 text-red-200'}">
                                    <p class="font-bold text-lg">${quizState.lastAnswerCorrect ? 'Chính xác!' : 'Sai rồi!'}</p>
                                    <p class="text-white">Đáp án đúng là: <strong class="text-xl">${question.correctAnswer}</strong></p>
                                    <button id="next-quiz-btn" class="btn-primary mt-4">Tiếp theo</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                container.innerHTML = html;
                // NOTE: All button listeners are now delegated
            },

            startQuiz(type) {
                this.state.quiz.type = type;
                this.state.quiz.currentQuestionIndex = 0;
                this.state.quiz.correctAnswers = 0;
                this.state.quiz.showAnswer = false;

                const shuffledVerbs = [...this.state.verbs].sort(() => 0.5 - Math.random());
                this.state.quiz.questions = shuffledVerbs.map(verb => {
                    const correctAnswer = type === 'te' ? verb.teForm : verb.naiForm;
                    const wrongAnswers = this.state.verbs.filter(v => v.id !== verb.id).sort(() => 0.5 - Math.random()).slice(0, 3).map(v => type === 'te' ? v.teForm : v.naiForm);
                    const options = [...new Set([correctAnswer, ...wrongAnswers])].sort(() => 0.5 - Math.random());
                    while(options.length < 4) {
                        const randomVerb = this.state.verbs[Math.floor(Math.random() * this.state.verbs.length)];
                        const randomOption = type === 'te' ? randomVerb.teForm : randomVerb.naiForm;
                        if (!options.includes(randomOption)) options.push(randomOption);
                    }
                    return { verb, correctAnswer, options: options.slice(0, 4) };
                });
                this.renderQuiz(type);
            },

            checkQuizAnswer(selectedAnswer) {
                const quizState = this.state.quiz;
                const question = quizState.questions[quizState.currentQuestionIndex];
                quizState.showAnswer = true;
                quizState.lastAnswerCorrect = selectedAnswer === question.correctAnswer;
                if (quizState.lastAnswerCorrect) quizState.correctAnswers++;
                this.renderQuiz(quizState.type);
            },

            nextQuizQuestion() {
                this.state.quiz.currentQuestionIndex++;
                this.state.quiz.showAnswer = false;
                this.renderQuiz(this.state.quiz.type);
            },

            // 7. HIỂN THỊ GHI CHÚ
            renderNotes() {
                const container = document.getElementById('view-notes');
                const verbsWithNotes = this.state.verbs.filter(verb => verb.note && verb.note.trim() !== '');
                
                let html = `<h2 class="text-4xl font-bold mb-8 text-white">Ghi chú</h2>`;

                if (verbsWithNotes.length === 0) {
                    html += `
                        <div class="glass-card p-8 text-center">
                            <i data-lucide="sticky-note" class="mx-auto h-16 w-16 text-gray-400 mb-4"></i>
                            <h3 class="text-2xl font-bold text-white mb-2">Chưa có ghi chú</h3>
                            <p class="text-lg text-gray-300">Bạn chưa có ghi chú nào. Hãy thêm ghi chú trong phần Tổng quan!</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="glass-card overflow-hidden">
                            <div class="notes-list">
                    `;
                    verbsWithNotes.forEach(verb => {
                        html += `
                            <div class="note-item cursor-pointer" data-verb-id="${verb.id}">
                                <div class="note-header">
                                    <div>
                                        <span class="note-verb">${verb.kanji} <span class="note-reading">(${verb.hiragana})</span></span>
                                        <span class="text-sm text-gray-400">#${verb.id}</span>
                                    </div>
                                    <button class="delete-note-btn text-gray-500 hover:text-red-400 p-1 rounded-full" data-verb-id="${verb.id}">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="note-content">${verb.note}</div>
                            </div>
                        `;
                    });
                    html += `
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
                // NOTE: Event listeners are now delegated
            },

            // 8. CÀI ĐẶT
            renderSettings() {
                const container = document.getElementById('view-settings');
                const isDark = this.state.settings.theme === 'dark';
                container.innerHTML = `
                    <h2 class="text-4xl font-bold mb-8 text-white">Cài đặt</h2>
                    <div class="space-y-8 max-w-2xl">
                        <div class="glass-card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-white">Giao diện</h3>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-200">Giao diện tối</span>
                                <label for="theme-toggle" class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="theme-toggle" class="sr-only" ${isDark ? 'checked' : ''}>
                                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform"></div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="glass-card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-white">Quản lý dữ liệu</h3>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button id="export-data" class="btn-primary flex-1">
                                    <i data-lucide="download" class="inline-block mr-2 h-5 w-5"></i>Xuất dữ liệu
                                </button>
                                <button id="import-data-btn" class="btn-secondary flex-1">
                                    <i data-lucide="upload" class="inline-block mr-2 h-5 w-5"></i>Nhập dữ liệu
                                </button>
                                <button id="reset-data" class="btn-secondary flex-1 !border-red-500 !text-red-500 hover:!bg-red-500/10">
                                    <i data-lucide="trash-2" class="inline-block mr-2 h-5 w-5"></i>Xóa dữ liệu
                                </button>
                                <input type="file" id="import-file-input" class="hidden" accept=".json">
                            </div>
                            <p class="text-sm text-gray-400 mt-4">Lưu lại tiến trình học của bạn hoặc chuyển sang thiết bị khác.</p>
                        </div>
                        
                        <div class="glass-card p-6">
                           <h3 class="text-xl font-semibold mb-4 text-white">Thông tin tác giả</h3>
                           <p class="text-gray-300">Trang web được thiết kế lại bởi Gemini theo phong cách Glassmorphism.</p>
                           <p class="mt-2 text-gray-300">Mục tiêu: Giúp bạn chinh phục 132 động từ N5 một cách hiệu quả và vui vẻ.</p>
                        </div>
                    </div>
                `;
                
                this.setupSettingsListeners();
            },

            setupSettingsListeners() {
                const toggle = document.getElementById('theme-toggle');
                toggle.addEventListener('change', () => {
                    this.state.settings.theme = toggle.checked ? 'dark' : 'light';
                    this.saveSettings();
                });

                document.getElementById('export-data').addEventListener('click', () => {
                    const dataStr = JSON.stringify(this.state.verbs);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', 'n5_verbs_progress.json');
                    linkElement.click();
                });

                const importBtn = document.getElementById('import-data-btn');
                const fileInput = document.getElementById('import-file-input');
                importBtn.addEventListener('click', () => fileInput.click());

                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (Array.isArray(importedData) && importedData.length > 0 && 'kanji' in importedData[0]) {
                                this.state.verbs = importedData;
                                this.saveData();
                                this.showCustomAlert('Nhập dữ liệu thành công! Trang sẽ được tải lại.');
                                setTimeout(() => location.reload(), 2000);
                            } else {
                                this.showCustomAlert('Lỗi: File dữ liệu không hợp lệ.', 'error');
                            }
                        } catch (error) {
                            this.showCustomAlert('Lỗi: Không thể đọc file. Vui lòng kiểm tra lại định dạng file JSON.', 'error');
                        }
                    };
                    reader.readAsText(file);
                });

                document.getElementById('reset-data').addEventListener('click', () => {
                    this.showConfirmationModal('Bạn có chắc chắn muốn xóa toàn bộ dữ liệu học tập? Hành động này không thể hoàn tác.', () => {
                        this.state.verbs = JSON.parse(JSON.stringify(n5Verbs));
                        this.saveData();
                        this.showCustomAlert('Đã xóa toàn bộ dữ liệu học tập.', 'success');
                        setTimeout(() => location.reload(), 2000);
                    });
                });
            },

            // --- TIỆN ÍCH ---
            showConfirmationModal(message, onConfirm) {
                const modalContainer = document.getElementById('modal-container');
                modalContainer.innerHTML = `
                    <div id="confirmation-modal-overlay" class="modal-overlay visible">
                        <div class="modal-content glass-card w-full max-w-sm m-4 p-6 text-center" onclick="event.stopPropagation()">
                            <p class="text-lg text-white mb-6">${message}</p>
                            <div class="flex justify-center gap-4">
                                <button id="confirm-yes" class="btn-primary !bg-red-500/80 !border-red-500 !text-white flex-1">Xác nhận</button>
                                <button id="confirm-no" class="btn-secondary flex-1">Hủy</button>
                            </div>
                        </div>
                    </div>
                `;

                const closeModal = () => {
                    const overlay = document.getElementById('confirmation-modal-overlay');
                    if (overlay) {
                        overlay.classList.remove('visible');
                        setTimeout(() => {
                            overlay.parentElement.innerHTML = '';
                        }, 300);
                    }
                };

                document.getElementById('confirm-yes').addEventListener('click', () => {
                    onConfirm();
                    closeModal();
                });
                document.getElementById('confirm-no').addEventListener('click', closeModal);
                document.getElementById('confirmation-modal-overlay').addEventListener('click', closeModal);
            },
            applyTheme() {
                const html = document.documentElement;
                if (this.state.settings.theme === 'dark') {
                    html.classList.add('dark');
                    html.classList.remove('light');
                } else {
                    html.classList.add('light');
                    html.classList.remove('dark');
                }
            },
            
            showCustomAlert(message, type = 'success') {
                const alertEl = document.createElement('div');
                alertEl.style.position = 'fixed';
                alertEl.style.top = '20px';
                alertEl.style.right = '20px';
                alertEl.style.padding = '16px 24px';
                alertEl.style.borderRadius = '12px';
                alertEl.style.color = 'white';
                alertEl.style.zIndex = '1000';
                alertEl.style.opacity = '0';
                alertEl.style.transition = 'opacity 0.3s';
                alertEl.textContent = message;

                if (type === 'success') {
                    alertEl.style.backgroundColor = 'rgba(16, 185, 129, 0.8)'; // green-500
                } else {
                    alertEl.style.backgroundColor = 'rgba(239, 68, 68, 0.8)'; // red-500
                }
                
                // Glass effect for alert
                alertEl.style.backdropFilter = 'blur(10px)';
                alertEl.style.webkitBackdropFilter = 'blur(10px)';
                alertEl.style.border = '1px solid rgba(255, 255, 255, 0.2)';

                document.body.appendChild(alertEl);
                
                setTimeout(() => { alertEl.style.opacity = '1'; }, 10);
                setTimeout(() => {
                    alertEl.style.opacity = '0';
                    setTimeout(() => alertEl.remove(), 300);
                }, 3000);
            },

            // Xáo trộn mảng
            shuffleArray(array) {
                // Fisher-Yates shuffle algorithm
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },
        };

        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

    </script>
</body>
</ht